# monoGIFPlayer

## 概要

**monogifplay** は、1985〜1992年頃の 680x0系CPUを持つ一部のワークステーションで存在した 1bpp (1 bit per pixel) フレームバッファ用のXサーバーをターゲットに、アニメーションGIF画像を実用的(?)な速度で表示するために作ったものです。  
事前にモノクロ化されたアニメーションGIF画像を再生することを想定していますが、カラーのアニメーションGIF画像に対してもRGB階調を使った単純2値化によるモノクロ化の上で表示します。

## 特長

- 1 bpp フレームバッファでの高速表示(?)に特化
- クロック 20 MHz、RAM 16 MB といった35〜40年前のマシンでもとりあえずアニメーションと呼べる速度で再生動作可能
  - Sun 3/60 (CPU MC68020 20MHz, RAM 24MB) で 960x540 10フレームのアニメーションGIF画像を 1フレームあたり 60ms 程度で再生可能
  - ただし、大きめのアニメーションGIF画像の場合、画像データデコード、 1bppビットマップデータの生成など、再生開始までにかなりの時間がかかります
- C言語のみで実装し、必要なライブラリは gif-lib のみで、現実的な時間でビルド可能
  - Sun 3/60 でのバイナリコンパイル時間は 7分程度（gif-libライブラリ除く）
- 1 bpp 以外のフレームバッファでも表示可能（デバッグ用）

## 動作例

Sun 3/60 での動作例動画は以下の X （旧Twitter）のポストを参照してください
- https://x.com/tsutsuii/status/1930958183025320048
- https://x.com/tsutsuii/status/1931318846843203982

## 使い方

```sh
monogifplay [-d] [-p] [-g geometry] animated.gif
```

### オプション

| オプション    | 内容 |
|---------------|------|
| `-p`	        | GIF画像の読み込みと各フレームの処理の進捗を表示します。 |
| `-d`          | GIF画像の読み込みと各フレームの処理の進捗とかかった時間を表示します。 |
| `-g geometry` | ウインドウの表示位置およびサイズをX11アプリ一般のGEOMETRY形式で指定します。 |

`-p` オプションと `-d` オプションは本アプリがターゲットとしているm68kのような遅いマシン向けです。

### 引数

- `animated.gif`  : 再生するアニメーションGIFファイル

## ビルド方法

必要なライブラリ:

- giflib 5.1以降 （要 `DGifSavedExtensionToGCB()`）
  - pkgsrcの場合は `pkg_add giflib`
  - ubuntuの場合は `apt install libgif-dev`

```sh
make
```
ライブラリやヘッダのパスは適当に調整してください。デフォルトでは NetBSD + pkgsrc の設定が書いてあります。

## 白黒アニメーションGIF画像

ImageMagickやffmpegでもアニメーションGIFは作成可能ですが、それらはモノクロ化のための減色アルゴリズムや機能がイマイチだったので、 [animegif2mono](https://github.com/tsutsui/animegif2mono) という別のアプリを作ってカラーのアニメーションGIFのモノクロ変換に使用しています。

## なぜこんなものを作ったの？

世間のほとんどの画像フォーマットは、1ピクセルあたり1バイトあるいは3バイトといった形式です。  
一方、 1bpp のXサーバー（というかVRAM）では、1ピクセルが1ビット、つまり1バイト中に8ドット分の情報を持たせる必要があります。

こういったVRAMに対して通常の画像フォーマットを表示させる場合、バイト単位のデータを1バイト内のビット単位で展開して変換する必要がありますが、ほとんどのアプリケーションはその変換をXサーバー側のAPIに任せる実装になっているようです。

一例として、sxivという古くからある画像表示アプリは一応モノクロXサーバーでも動作するのですが、アニメーションGIFを表示させると1フレームあたり10秒以上の時間がかかります。  
また、1980年代から存在する有名な画像表示アプリであるxvでも、モノクロサーバー上ではたとえ元画像がモノクロ画像であったとしてもロードのたびにかなり待たされてしまいます。

しかし、「変換をXサーバー側のAPIに任せる」ことができるということは、画像データを 1bpp 形式で持っておけばXサーバー側は渡されたデータをそのままVRAMに書くだけで済む、ということです（もっとも、X座標で8ピクセル未満のズレがあった場合はビットシフト処理と重ね合わせ処理が必要になりますが、Xサーバー実装はそのあたりも一応最適化されているようです）。

そこで、この monogifplayでは、事前にアニメーションGIFのフレーム数分だけ 1bpp 形式のビットマップデータを生成してそれをpixmapとしてオンメモリで保持し、再生を開始したらひたすらそのデータを`XCopyPlane()`でXサーバーに投げる、ということをしているだけです。モノクロ画像はその分データ量が少ないということもあり、転送だけならばそれなりの速度が出る、というわけです。

逆に 1bpp のビットマップデータをいまどきの 24bppのXサーバーで表示させる場合はXサーバー側で展開処理が走ることになりますが、今どきのマシンは十分に速いので全く問題にならない速度で動くようです。

## ライセンス

このソフトウェアのライセンスは [LICENSE](LICENSE) ファイルを参照してください。
